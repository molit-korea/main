/* (c) 2019 Open Source Geospatial Foundation - all rights reserved
 * This code is licensed under the GPL 2.0 license, available at the root
 * application directory.
 * Copyright © 2019 World Wide Web Consortium, (Massachusetts Institute of Technology, 
 * European Research Consortium for Informatics and Mathematics, Keio    
 * University, Beihang). All Rights Reserved. This work is distributed under the 
 * W3C® Software License [1] in the hope that it will be useful, but WITHOUT ANY 
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR 
 * A PARTICULAR PURPOSE.
 * [1] http://www.w3.org/Consortium/Legal/copyright-software
*/

/*! mapml-leaflet-client 30-07-2019 */

function URI(t){t||(t="");var e=t.match(/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/);this.scheme=e[1]||null,this.authority=e[2]||null,this.path=e[3]||null,this.query=e[4]||null,this.fragment=e[5]||null}!function(t,e,i){var n={};t.M=n,n.detectImagePath=function(t){var e=L.DomUtil.create("div","leaflet-default-icon-path",t),i=L.DomUtil.getStyle(e,"background-image")||L.DomUtil.getStyle(e,"backgroundImage");return Polymer.dom(t).removeChild(e),i=null===i||0!==i.indexOf("url")?"":i.replace(/^url\(["']?/,"").replace(/marker-icon\.png["']?\)$/,"")},n.mime="text/mapml",n.WGS84=new L.Proj.CRS("EPSG:4326","+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs ",{origin:[-180,90],bounds:L.bounds([[-180,-90],[180,90]]),resolutions:[.703125,.3515625,.17578125,.087890625,.0439453125,.02197265625,.010986328125,.0054931640625,.00274658203125,.001373291015625,.0006866455078125,.0003433227539062,.0001716613769531,858306884766e-16,429153442383e-16,214576721191e-16,107288360596e-16,53644180298e-16,26822090149e-16,13411045074e-16,6.705522537e-7,3.352761269e-7],crs:{tcrs:{horizontal:{name:"x",min:0,max:t=>(n.WGS84.options.bounds.getSize().x/n.WGS84.options.resolutions[t]).toFixed()},vertical:{name:"y",min:0,max:t=>(n.WGS84.options.bounds.getSize().y/n.WGS84.options.resolutions[t]).toFixed()},bounds:t=>L.bounds([n.WGS84.options.crs.tcrs.horizontal.min,n.WGS84.options.crs.tcrs.vertical.min],[n.WGS84.options.crs.tcrs.horizontal.max(t),n.WGS84.options.crs.tcrs.vertical.max(t)])},pcrs:{horizontal:{name:"longitude",get min(){return n.WGS84.options.crs.gcrs.horizontal.min},get max(){return n.WGS84.options.crs.gcrs.horizontal.max}},vertical:{name:"latitude",get min(){return n.WGS84.options.crs.gcrs.vertical.min},get max(){return n.WGS84.options.crs.gcrs.vertical.max}},get bounds(){return n.WGS84.options.bounds}},gcrs:{horizontal:{name:"longitude",min:-180,max:180},vertical:{name:"latitude",min:-90,max:90},get bounds(){return L.latLngBounds([n.WGS84.options.crs.gcrs.vertical.min,n.WGS84.options.crs.gcrs.horizontal.min],[n.WGS84.options.crs.gcrs.vertical.max,n.WGS84.options.crs.gcrs.horizontal.max])}},map:{horizontal:{name:"i",min:0,max:t=>t.getSize().x},vertical:{name:"j",min:0,max:t=>t.getSize().y},bounds:t=>L.bounds(L.point([0,0]),t.getSize())},tile:{horizontal:{name:"i",min:0,max:256},vertical:{name:"j",min:0,max:256},get bounds(){return L.bounds([n.WGS84.options.crs.tile.horizontal.min,n.WGS84.options.crs.tile.vertical.min],[n.WGS84.options.crs.tile.horizontal.max,n.WGS84.options.crs.tile.vertical.max])}},tilematrix:{horizontal:{name:"column",min:0,max:t=>(n.WGS84.options.crs.tcrs.horizontal.max(t)/n.WGS84.options.crs.tile.bounds.getSize().x).toFixed()},vertical:{name:"row",min:0,max:t=>(n.WGS84.options.crs.tcrs.vertical.max(t)/n.WGS84.options.crs.tile.bounds.getSize().y).toFixed()},bounds:t=>L.bounds([n.WGS84.options.crs.tilematrix.horizontal.min,n.WGS84.options.crs.tilematrix.vertical.min],[n.WGS84.options.crs.tilematrix.horizontal.max(t),n.WGS84.options.crs.tilematrix.vertical.max(t)])}}}),n.CBMTILE=new L.Proj.CRS("EPSG:3978","+proj=lcc +lat_1=49 +lat_2=77 +lat_0=49 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs",{origin:[-34655800,3931e4],bounds:L.bounds([[-34655800,-39e6],[1e7,3931e4]]),resolutions:[38364.660062653464,22489.62831258996,13229.193125052918,7937.5158750317505,4630.2175937685215,2645.8386250105837,1587.5031750063501,926.0435187537042,529.1677250021168,317.50063500127004,185.20870375074085,111.12522225044451,66.1459656252646,38.36466006265346,22.48962831258996,13.229193125052918,7.9375158750317505,4.6302175937685215,2.6458386250105836,1.5875031750063502,.9260435187537043,.5291677250021167,.31750063500127,.18520870375074083,.11112522225044451,.06614596562526459],crs:{tcrs:{horizontal:{name:"x",min:0,max:t=>(n.CBMTILE.options.bounds.getSize().x/n.CBMTILE.options.resolutions[t]).toFixed()},vertical:{name:"y",min:0,max:t=>(n.CBMTILE.options.bounds.getSize().y/n.CBMTILE.options.resolutions[t]).toFixed()},bounds:t=>L.bounds([n.CBMTILE.options.crs.tcrs.horizontal.min,n.CBMTILE.options.crs.tcrs.vertical.min],[n.CBMTILE.options.crs.tcrs.horizontal.max(t),n.CBMTILE.options.crs.tcrs.vertical.max(t)])},pcrs:{horizontal:{name:"easting",get min(){return n.CBMTILE.options.bounds.min.x},get max(){return n.CBMTILE.options.bounds.max.x}},vertical:{name:"northing",get min(){return n.CBMTILE.options.bounds.min.y},get max(){return n.CBMTILE.options.bounds.max.y}},get bounds(){return n.CBMTILE.options.bounds}},gcrs:{horizontal:{name:"longitude",min:-141.01,max:-47.74},vertical:{name:"latitude",min:40.04,max:86.46},get bounds(){return L.latLngBounds([n.CBMTILE.options.crs.gcrs.vertical.min,n.CBMTILE.options.crs.gcrs.horizontal.min],[n.CBMTILE.options.crs.gcrs.vertical.max,n.CBMTILE.options.crs.gcrs.horizontal.max])}},map:{horizontal:{name:"i",min:0,max:t=>t.getSize().x},vertical:{name:"j",min:0,max:t=>t.getSize().y},bounds:t=>L.bounds(L.point([0,0]),t.getSize())},tile:{horizontal:{name:"i",min:0,max:256},vertical:{name:"j",min:0,max:256},get bounds(){return L.bounds([n.CBMTILE.options.crs.tile.horizontal.min,n.CBMTILE.options.crs.tile.vertical.min],[n.CBMTILE.options.crs.tile.horizontal.max,n.CBMTILE.options.crs.tile.vertical.max])}},tilematrix:{horizontal:{name:"column",min:0,max:t=>(n.CBMTILE.options.crs.tcrs.horizontal.max(t)/n.CBMTILE.options.crs.tile.bounds.getSize().x).toFixed()},vertical:{name:"row",min:0,max:t=>(n.CBMTILE.options.crs.tcrs.vertical.max(t)/n.CBMTILE.options.crs.tile.bounds.getSize().y).toFixed()},bounds:t=>L.bounds([0,0],[n.CBMTILE.options.crs.tilematrix.horizontal.max(t),n.CBMTILE.options.crs.tilematrix.vertical.max(t)])}}}),n.APSTILE=new L.Proj.CRS("EPSG:5936","+proj=stere +lat_0=90 +lat_ts=50 +lon_0=-150 +k=0.994 +x_0=2000000 +y_0=2000000 +datum=WGS84 +units=m +no_defs",{origin:[-28567784.109255,32567784.109255],bounds:L.bounds([[-28567784.109254867,-28567784.109254755],[32567784.109255023,32567784.10925506]]),resolutions:[238810.813354,119405.406677,59702.7033384999,29851.3516692501,14925.675834625,7462.83791731252,3731.41895865639,1865.70947932806,932.854739664032,466.427369832148,233.213684916074,116.606842458037,58.3034212288862,29.1517106145754,14.5758553072877,7.28792765351156,3.64396382688807,1.82198191331174,.910990956788164,.45549547826179],crs:{tcrs:{horizontal:{name:"x",min:0,max:t=>(n.APSTILE.options.bounds.getSize().x/n.APSTILE.options.resolutions[t]).toFixed()},vertical:{name:"y",min:0,max:t=>(n.APSTILE.options.bounds.getSize().y/n.APSTILE.options.resolutions[t]).toFixed()},bounds:t=>L.bounds([n.APSTILE.options.crs.tcrs.horizontal.min,n.APSTILE.options.crs.tcrs.vertical.min],[n.APSTILE.options.crs.tcrs.horizontal.max(t),n.APSTILE.options.crs.tcrs.vertical.max(t)])},pcrs:{horizontal:{name:"easting",get min(){return n.APSTILE.options.bounds.min.x},get max(){return n.APSTILE.options.bounds.max.x}},vertical:{name:"northing",get min(){return n.APSTILE.options.bounds.min.y},get max(){return n.APSTILE.options.bounds.max.y}},get bounds(){return n.APSTILE.options.bounds}},gcrs:{horizontal:{name:"longitude",min:-180,max:180},vertical:{name:"latitude",min:60,max:90},get bounds(){return L.latLngBounds([n.APSTILE.options.crs.gcrs.vertical.min,n.APSTILE.options.crs.gcrs.horizontal.min],[n.APSTILE.options.crs.gcrs.vertical.max,n.APSTILE.options.crs.gcrs.horizontal.max])}},map:{horizontal:{name:"i",min:0,max:t=>t.getSize().x},vertical:{name:"j",min:0,max:t=>t.getSize().y},bounds:t=>L.bounds(L.point([0,0]),t.getSize())},tile:{horizontal:{name:"i",min:0,max:256},vertical:{name:"j",min:0,max:256},get bounds(){return L.bounds([n.APSTILE.options.crs.tile.horizontal.min,n.APSTILE.options.crs.tile.vertical.min],[n.APSTILE.options.crs.tile.horizontal.max,n.APSTILE.options.crs.tile.vertical.max])}},tilematrix:{horizontal:{name:"column",min:0,max:t=>(n.APSTILE.options.crs.tcrs.horizontal.max(t)/n.APSTILE.options.crs.tile.bounds.getSize().x).toFixed()},vertical:{name:"row",min:0,max:t=>(n.APSTILE.options.crs.tcrs.vertical.max(t)/n.APSTILE.options.crs.tile.bounds.getSize().y).toFixed()},bounds:t=>L.bounds([0,0],[n.APSTILE.options.crs.tilematrix.horizontal.max(t),n.APSTILE.options.crs.tilematrix.vertical.max(t)])}}}),n.OSMTILE=L.CRS.EPSG3857,L.setOptions(n.OSMTILE,{origin:[-20037508.342787,20037508.342787],bounds:L.bounds([[-20037508.342787,-20037508.342787],[20037508.342787,20037508.342787]]),resolutions:[156543.0339,78271.51695,39135.758475,19567.8792375,9783.93961875,4891.969809375,2445.9849046875,1222.9924523438,611.49622617188,305.74811308594,152.87405654297,76.437028271484,38.218514135742,19.109257067871,9.5546285339355,4.7773142669678,2.3886571334839,1.1943285667419,.59716428337097,.29858214168549,.14929107084274,.074645535421371,.03732276771068573,.018661383855342866,.009330691927671433],crs:{tcrs:{horizontal:{name:"x",min:0,max:t=>(n.OSMTILE.options.bounds.getSize().x/n.OSMTILE.options.resolutions[t]).toFixed()},vertical:{name:"y",min:0,max:t=>(n.OSMTILE.options.bounds.getSize().y/n.OSMTILE.options.resolutions[t]).toFixed()},bounds:t=>L.bounds([n.OSMTILE.options.crs.tcrs.horizontal.min,n.OSMTILE.options.crs.tcrs.vertical.min],[n.OSMTILE.options.crs.tcrs.horizontal.max(t),n.OSMTILE.options.crs.tcrs.vertical.max(t)])},pcrs:{horizontal:{name:"easting",get min(){return n.OSMTILE.options.bounds.min.x},get max(){return n.OSMTILE.options.bounds.max.x}},vertical:{name:"northing",get min(){return n.OSMTILE.options.bounds.min.y},get max(){return n.OSMTILE.options.bounds.max.y}},get bounds(){return n.OSMTILE.options.bounds}},gcrs:{horizontal:{name:"longitude",get min(){return n.OSMTILE.unproject(n.OSMTILE.options.bounds.min).lng},get max(){return n.OSMTILE.unproject(n.OSMTILE.options.bounds.max).lng}},vertical:{name:"latitude",get min(){return n.OSMTILE.unproject(n.OSMTILE.options.bounds.min).lat},get max(){return n.OSMTILE.unproject(n.OSMTILE.options.bounds.max).lat}},get bounds(){return L.latLngBounds([n.OSMTILE.options.crs.gcrs.vertical.min,n.OSMTILE.options.crs.gcrs.horizontal.min],[n.OSMTILE.options.crs.gcrs.vertical.max,n.OSMTILE.options.crs.gcrs.horizontal.max])}},map:{horizontal:{name:"i",min:0,max:t=>t.getSize().x},vertical:{name:"j",min:0,max:t=>t.getSize().y},bounds:t=>L.bounds(L.point([0,0]),t.getSize())},tile:{horizontal:{name:"i",min:0,max:256},vertical:{name:"j",min:0,max:256},get bounds(){return L.bounds([n.OSMTILE.options.crs.tile.horizontal.min,n.OSMTILE.options.crs.tile.vertical.min],[n.OSMTILE.options.crs.tile.horizontal.max,n.OSMTILE.options.crs.tile.vertical.max])}},tilematrix:{horizontal:{name:"column",min:0,max:t=>(n.OSMTILE.options.crs.tcrs.horizontal.max(t)/n.OSMTILE.options.crs.tile.bounds.getSize().x).toFixed()},vertical:{name:"row",min:0,max:t=>(n.OSMTILE.options.crs.tcrs.vertical.max(t)/n.OSMTILE.options.crs.tile.bounds.getSize().y).toFixed()},bounds:t=>L.bounds([0,0],[n.OSMTILE.options.crs.tilematrix.horizontal.max(t),n.OSMTILE.options.crs.tilematrix.vertical.max(t)])}}}),n.getBounds=function(t){var e=t.hasAttribute("units")&&""!==t.getAttribute("units")?t.getAttribute("units").toUpperCase():"OSMTILE",i=n[e];if(t.querySelector("input[type=zoom]")?t.querySelector("input[type=zoom]").getAttribute("value"):null){if(void 0!==i)return i.options.bounds;console.log("No matching TCRS found for: "+e)}else console.log("No zoom found")},n.Util={coordsToArray:function(t){for(var e=1,i=[],n=t.split(",");e<n.length;e+=2)i.push([parseInt(n[e-1]),parseInt(n[e])]);return i}},n.coordsToArray=n.Util.coordsToArray,n.QueryHandler=L.Handler.extend({addHooks:function(){L.setOptions(this,{mapEl:this._map.options.mapEl}),L.DomEvent.on(this._map,"click",this._queryTopLayer,this),L.DomEvent.on(this._map,"keypress",this._queryTopLayerAtMapCenter,this)},removeHooks:function(){L.DomEvent.off(this._map,"click",this._queryTopLayer,this),L.DomEvent.on(this._map,"keypress",this._queryTopLayerAtMapCenter,this)},_getTopQueryableLayer:function(){for(var t=this.options.mapEl.layers,e=t.length-1;e>=0;e--){var i=t[e]._layer;if(t[e].checked&&i.queryable)return i}},_queryTopLayerAtMapCenter:function(t){" "===t.originalEvent.key&&this._map.fire("click",{latlng:this._map.getCenter(),layerPoint:this._map.latLngToLayerPoint(this._map.getCenter()),containerPoint:this._map.latLngToContainerPoint(this._map.getCenter())})},_queryTopLayer:function(t){var e=this._getTopQueryableLayer();e&&this._query(t,e)},_query(t,i){var r={},a=i.getQueryTemplates()[0],o=t.target.getZoom(),s=this._map,l=i.crs,m=i._container,u={autoPan:!0,maxHeight:.5*s.getSize().y-50},h=function(t){return l.transformation.untransform(t,l.scale(o))},p=l.latLngToPoint(t.latlng,o),c=p.divideBy(256).floor(),d=new L.Bounds(p.divideBy(256).floor().multiplyBy(256),p.divideBy(256).ceil().multiplyBy(256));for(var g in r[a.query.tilei]=p.x.toFixed()-256*c.x,r[a.query.tilej]=p.y.toFixed()-256*c.y,r[a.query.mapi]=s.getSize().divideBy(2).x.toFixed(),r[a.query.mapj]=s.getSize().divideBy(2).y.toFixed(),r[a.query.pixelleft]=l.pointToLatLng(p,o).lng,r[a.query.pixeltop]=l.pointToLatLng(p,o).lat,r[a.query.pixelright]=l.pointToLatLng(p.add([1,1]),o).lng,r[a.query.pixelbottom]=l.pointToLatLng(p.add([1,1]),o).lat,r[a.query.column]=c.x,r[a.query.row]=c.y,r[a.query.x]=p.x.toFixed(),r[a.query.y]=p.y.toFixed(),r[a.query.easting]=h(p).x,r[a.query.northing]=h(p).y,r[a.query.zoom]=o,r[a.query.width]=s.getSize().x,r[a.query.height]=s.getSize().y,r[a.query.mapbottom]=h(p.add(s.getSize().divideBy(2))).y,r[a.query.mapleft]=h(p.subtract(s.getSize().divideBy(2))).x,r[a.query.maptop]=h(p.subtract(s.getSize().divideBy(2))).y,r[a.query.mapright]=h(p.add(s.getSize().divideBy(2))).x,r[a.query.tilebottom]=h(d.max).y,r[a.query.tileleft]=h(d.min).x,r[a.query.tiletop]=h(d.min).y,r[a.query.tileright]=h(d.max).x,a.query)["mapi","mapj","tilei","tilej","row","col","x","y","easting","northing","width","height","zoom","mapleft","mapright",",maptop","mapbottom","tileleft","tileright","tiletop","tilebottom","pixeltop","pixelbottom","pixelleft","pixelright"].indexOf(g)<0&&(r[g]=a.query[g]);fetch(L.Util.template(a.template,r),{redirect:"follow"}).then(function(t){return t.status>=200&&t.status<300?Promise.resolve(t):(console.log("Looks like there was a problem. Status Code: "+t.status),Promise.reject(t))}).then(function(r){return r.headers.get("Content-Type").startsWith("text/mapml")?function(t,r){return t.text().then(t=>{var a=L.bind(l.unproject,l);var o=new DOMParser,h=o.parseFromString(t,"application/xml"),p=n.mapMlFeatures(h,{renderer:L.svg(),pane:m,color:"yellow",coordsToLatLng:function(t){return a(L.point(t))},imagePath:n.detectImagePath(s.getContainer())});p.addTo(s);var c=e.createElement("iframe");c.csp="script-src 'none'",c.style="border: none",c.srcdoc=h.querySelector("feature properties").innerHTML,i.bindPopup(c,u).openPopup(r),i.on("popupclose",function(){s.removeLayer(p)})})}(r,t.latlng):function(t,i,n){return t.text().then(t=>{var r=e.createElement("iframe");r.csp="script-src 'none'",r.style="border: none",r.srcdoc=t,i.bindPopup(r,u).openPopup(n)})}(r,i,t.latlng)}).catch(function(t){})}}),L.Map.addInitHook("addHandler","query",n.QueryHandler),n.MapMLLayer=L.Layer.extend({options:{maxNext:10,zIndex:0,maxZoom:25},initialize:function(t,e,i){t&&(this._href=t),this._layerEl=e;var n=!!e.querySelector("image,feature,tile,extent");n&&(this._content=e),this._container=L.DomUtil.create("div","leaflet-layer"),L.DomUtil.addClass(this._container,"mapml-layer"),this._imageContainer=L.DomUtil.create("div","leaflet-layer",this._container),L.DomUtil.addClass(this._imageContainer,"mapml-image-container"),this._mapmlTileContainer=L.DomUtil.create("div","mapml-tile-container",this._container),this._initCount=0,this._initExtent(n?e:null),this.on("attached",this._validateExtent,this),L.setOptions(this,i)},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},_updateZIndex:function(){this._container&&void 0!==this.options.zIndex&&null!==this.options.zIndex&&(this._container.style.zIndex=this.options.zIndex)},_changeOpacity:function(t){t&&t.target&&t.target.value>=0&&t.target.value<=1&&this.changeOpacity(t.target.value)},changeOpacity:function(t){this._container.style.opacity=t},onAdd:function(t){this._map=t,this._mapmlvectors||(this._mapmlvectors=n.mapMlFeatures(this._content,{renderer:L.svg(),pane:this._container,opacity:this.options.opacity,imagePath:n.detectImagePath(this._map.getContainer()),_leafletLayer:this,onEachFeature:function(t,i){if(t){var n=e.createElement("div");n.insertAdjacentHTML("afterbegin",t.innerHTML),i.bindPopup(n,{autoPan:!1})}}})),t.addLayer(this._mapmlvectors),this._imageLayer||(this._imageLayer=L.layerGroup()),t.addLayer(this._imageLayer),this._tileLayer||(this._tileLayer=n.mapMLTileLayer(this.href?this.href:this._href,{pane:this._container,_leafletLayer:this})),this._tileLayer._mapmlTileContainer=this._mapmlTileContainer,t.addLayer(this._tileLayer),this._tileLayer._container.appendChild(this._mapmlTileContainer),this._extent?this._templateVars&&(this._templatedLayer=n.templatedLayer(this._templateVars,{pane:this._container,imagePath:n.detectImagePath(this._map.getContainer()),_leafletLayer:this,crs:this.crs}).addTo(t)):(this.once("extentload",function(){this._templateVars&&(this._templatedLayer=n.templatedLayer(this._templateVars,{pane:this._container,imagePath:n.detectImagePath(this._map.getContainer()),_leafletLayer:this,crs:this.crs}).addTo(t))},this),this.once("extentload",this._onMoveEnd,this)),this.setZIndex(this.options.zIndex),Polymer.dom(this.getPane()).appendChild(this._container)},addTo:function(t){return t.addLayer(this),this},getEvents:function(){return{moveend:this._onMoveEnd,zoomanim:this._onZoomAnim}},redraw:function(){this._templatedLayer&&this._templatedLayer.redraw()},_onZoomAnim:function(t){var e=t.zoom,i=this._extent.querySelector("input[type=zoom]"),n=i&&i.hasAttribute("min")?parseInt(i.getAttribute("min")):this._map.getMinZoom(),r=i&&i.hasAttribute("max")?parseInt(i.getAttribute("max")):this._map.getMaxZoom(),a=e<n&&this._extent.zoomout||e>r&&this._extent.zoomin;this._extent.hasAttribute("action")||n<=e&&e<=r||(this._extent.zoomin&&e>r?(this._href=this._extent.zoomin,this.href=this._extent.zoomin):this._extent.zoomout&&e<n&&(this._href=this._extent.zoomout,this.href=this._extent.zoomout)),this._templatedLayer&&a&&this._initExtent()},onRemove:function(t){L.DomUtil.remove(this._container),t.removeLayer(this._mapmlvectors),t.removeLayer(this._tileLayer),t.removeLayer(this._imageLayer),this._templatedLayer&&t.removeLayer(this._templatedLayer)},getZoomBounds:function(){var t=this._extent,e=t?t.querySelector("[type=zoom]"):void 0,i=e&&e.hasAttribute("min")?e.getAttribute("min"):this._map.getMinZoom(),n=e&&e.hasAttribute("max")?e.getAttribute("max"):this._map.getMaxZoom(),r={};return r.min=Math.min(i,n),r.max=Math.max(i,n),r},_transformDeprectatedInput:function(t){var e=t.getAttribute("type").toLowerCase();if("xmin"===e||"ymin"===e||"xmax"===e||"ymax"===e)switch(t.setAttribute("type","location"),t.setAttribute("units","tcrs"),e){case"xmin":t.setAttribute("axis","x"),t.setAttribute("position","top-left");break;case"ymin":t.setAttribute("axis","y"),t.setAttribute("position","top-left");break;case"xmax":t.setAttribute("axis","x"),t.setAttribute("position","bottom-right");break;case"ymax":t.setAttribute("axis","y"),t.setAttribute("position","bottom-right")}},_setUpInputVars:function(t){var e={extent:{}};e.extent.hidden=[];for(var i=0;i<t.length;i++){this._transformDeprectatedInput(t[i]);var n=t[i].getAttribute("type"),r=t[i].getAttribute("units"),a=t[i].getAttribute("axis"),o=t[i].getAttribute("name"),s=t[i].getAttribute("position"),l=t[i].getAttribute("value");if("width"===n)e.extent.width={name:o};else if("height"===n)e.extent.height={name:o};else if("zoom"===n)e.extent.zoom={name:o};else if("location"!==n||"pcrs"!==r&&"gcrs"!==r&&"tcrs"!==r)"hidden"!==n&&"projection"!==n||e.extent.hidden.push({name:o,value:l});else switch(a){case"easting":s&&(s.match(/.*?-left/i)?e.extent.left={name:o,axis:a}:s.match(/.*?-right/i)&&(e.extent.right={name:o,axis:a}));break;case"northing":s&&(s.match(/top-.*?/i)?e.extent.top={name:o,axis:a}:s.match(/bottom-.*?/i)&&(e.extent.bottom={name:o,axis:a}));break;case"x":s&&(s.match(/.*?-left/i)?e.extent.left={name:o,axis:a}:s.match(/.*?-right/i)&&(e.extent.right={name:o,axis:a}));break;case"y":s&&(s.match(/top-.*?/i)?e.extent.top={name:o,axis:a}:s.match(/bottom-.*?/i)&&(e.extent.bottom={name:o,axis:a}));break;case"longitude":s&&(s.match(/.*?-left/i)?e.extent.left={name:o,axis:a}:s.match(/.*?-right/i)&&(e.extent.right={name:o,axis:a}));break;case"latitude":s&&(s.match(/top-.*?/i)?e.extent.top={name:o,axis:a}:s.match(/bottom-.*?/i)&&(e.extent.bottom={name:o,axis:a}))}}return e},getLayerExtentBounds:function(t){if(this._extent){var e,i,r,a,o,s,l,m,u=t.getZoom(),h=t.options.projection,p=h!==this._extent.getAttribute("units");if(s=this._extent.querySelector("[type=xmin]").getAttribute("min"),l=this._extent.querySelector("[type=xmax]").getAttribute("min"),i=Math.min(s,l),s=this._extent.querySelector("[type=xmin]").getAttribute("max"),l=this._extent.querySelector("[type=xmax]").getAttribute("max"),a=Math.max(s,l),s=this._extent.querySelector("[type=ymin]").getAttribute("min"),l=this._extent.querySelector("[type=ymax]").getAttribute("min"),r=Math.min(s,l),s=this._extent.querySelector("[type=ymin]").getAttribute("max"),l=this._extent.querySelector("[type=ymax]").getAttribute("max"),o=Math.max(s,l),p){var c=[(e=n[h]).latLngToPoint(L.latLng([r,i]),u),e.latLngToPoint(L.latLng([o,a]),u),e.latLngToPoint(L.latLng([r,i]),u),e.latLngToPoint(L.latLng([r,a]),u)];return L.bounds(c)}return(m=parseInt(this._extent.querySelector("[type=zoom]").getAttribute("value")))!==u?(e=n[h],L.bounds(e.latLngToPoint(e.pointToLatLng(L.point(i,r),m),u),e.latLngToPoint(e.pointToLatLng(L.point(a,o),m),u))):L.bounds(L.point(i,r),L.point(a,o))}},getAttribution:function(){return this.options.attribution},getLayerUserControlsHTML:function(){var t=e.createElement("label"),i=e.createElement("input"),n=e.createElement("span"),r=e.createElement("details"),a=e.createElement("summary"),o=e.createElement("input"),s=e.createElement("details"),l=e.createElement("summary");if(i.defaultChecked=!!this._map,i.type="checkbox",i.className="leaflet-control-layers-selector",n.draggable=!0,this._legendUrl){var m=e.createElement("a");m.text=" "+this._title,m.href=this._legendUrl,m.target="_blank",n.appendChild(m)}else n.innerHTML=" "+this._title;if(l.innerText="opacity",s.appendChild(l),s.appendChild(o),L.DomUtil.addClass(r,"mapml-control-layers"),L.DomUtil.addClass(s,"mapml-control-layers"),o.setAttribute("type","range"),o.setAttribute("min","0"),o.setAttribute("max","1.0"),o.setAttribute("value","1.0"),o.setAttribute("step","0.1"),L.DomEvent.on(o,"change",this._changeOpacity,this),L.DomEvent.on(n,"dragstart",function(t){this._href&&(t.dataTransfer.setData("text/uri-list",this._href),t.dataTransfer.setData("text/plain",this._href))},this),Polymer.dom(r).appendChild(a),Polymer.dom(t).appendChild(r),Polymer.dom(a).appendChild(i),Polymer.dom(a).appendChild(n),Polymer.dom(r).appendChild(s),this._styles&&Polymer.dom(r).appendChild(this._styles),this._userInputs){var u=e.createDocumentFragment(),h=this._templateVars;if(h)for(var p=0;p<h.length;p++)for(var c=h[p],d=0;d<c.values.length;d++){var g=c.values[d],y="#"+g.getAttribute("id");if("select"===g.tagName.toLowerCase()&&!u.querySelector(y)){var x=e.createElement("details"),f=e.createElement("summary");f.innerText=g.getAttribute("name"),L.DomUtil.addClass(x,"mapml-control-layers"),x.appendChild(f),x.appendChild(g.htmlselect),u.appendChild(x)}}Polymer.dom(r).appendChild(u)}return t},_initExtent:function(t){if(this._href||t){var i,r,a=this;if(this._href){var o=new XMLHttpRequest;i=this._href,r=s,o.onreadystatechange=function(){this.readyState===this.DONE&&(400!==this.status&&404!==this.status&&500!==this.status&&406!==this.status||(a.error=!0,a.fire("extentload",a,!0),o.abort()))},o.onload=r,o.onerror=function(){a.error=!0,a.fire("extentload",a,!0)},o.open("GET",i),o.setRequestHeader("Accept",n.mime),o.overrideMimeType("text/xml"),o.send()}else t&&s(t)}function s(t){var i=this.responseXML||t;if(this.readyState===this.DONE&&i){var n=i.querySelector("extent"),r=n&&n.hasAttribute("units")&&n.getAttribute("units").toUpperCase()===a.options.mapprojection,o=!r&&i.querySelector("head link[rel=alternate][projection="+a.options.mapprojection+"]"),s=new URI(i.querySelector("base")?i.querySelector("base").getAttribute("href"):this.responseURL).resolve(new URI(this.responseURL));if(n){if(!r&&o&&o.hasAttribute("href"))return void a.fire("changeprojection",{href:new URI(o.getAttribute("href")).resolve(s).toString()},!1);if(!n.hasAttribute("action")&&n.querySelector("link[rel=tile],link[rel=image],link[rel=features],link[rel=query]")&&n.hasAttribute("units")){a._templateVars=[];for(var l=n.querySelectorAll("link[rel=tile],link[rel=image],link[rel=features],link[rel=query]"),m=new RegExp("(?:{)(.*?)(?:})","g"),u=n.querySelector('input[type="zoom" i]'),h=!1,p=0;p<l.length;p++){for(var c,d=l[p],g=d.getAttribute("tref"),y=d.hasAttribute("title")?d.getAttribute("title"):"Query this layer",x=g.match(m),f=d.hasAttribute("rel")&&"tile"!==d.getAttribute("rel").toLowerCase()?d.getAttribute("rel").toLowerCase():"tile",_=[];null!==(c=m.exec(g));){var b=c[1],v=n.querySelector("input[name="+b+"],select[name="+b+"]");if(!v){console.log("input with name="+b+" not found for template variable of same name");break}if(_.push(v),h=v.hasAttribute("type")&&"zoom"===v.getAttribute("type").toLowerCase(),v.hasAttribute("shard")){var A=v.getAttribute("list");v.servers=[];var S=n.querySelectorAll("datalist#"+A+" > option");0===S.length&&v.hasAttribute("value")&&(S=v.getAttribute("value").split(""));for(var T=0;T<S.length;T++)S[T].getAttribute?v.servers.push(S[T].getAttribute("value")):v.servers.push(S[T])}else if("select"===v.tagName.toLowerCase()){var E=e.createElement("div");E.insertAdjacentHTML("afterbegin",v.outerHTML),v.htmlselect=E.querySelector("select"),L.DomEvent.on(v.htmlselect,"change",a.redraw,a),a._userInputs||(a._userInputs=[]),a._userInputs.push(v.htmlselect)}}g&&x.length===_.length&&("query"===f&&(a.queryable=!0),!h&&u&&_.push(u),a._templateVars.push({template:g,title:y,type:f,values:_}))}}}else n=a._synthesizeExtent(i),i.querySelector("feature,image,tile")&&(a._content=i);a._parseLicenseAndLegend(i,a),a._extent=n;var I=i.querySelector("link[rel=zoomin]"),z=i.querySelector("link[rel=zoomout]");delete a._extent.zoomin,delete a._extent.zoomout,I&&(a._extent.zoomin=new URI(I.getAttribute("href")).resolve(s).toString()),z&&(a._extent.zoomout=new URI(z.getAttribute("href")).resolve(s).toString()),a._templatedLayer&&a._templatedLayer.reset(a._templateVars);var q=i.querySelectorAll('link[rel=style],link[rel="self style"],link[rel="style self"]');if(q.length>1){var C=e.createElement("details"),M=e.createElement("summary");M.innerText="style",C.appendChild(M);for(var P=function(t){a.fire("changestyle",{src:t.target.getAttribute("data-href")},!1)},w=0;w<q.length;w++){var U=e.createElement("span"),O=U.appendChild(e.createElement("input"));O.setAttribute("type","radio"),O.setAttribute("id","rad"+w),O.setAttribute("name","styles"),O.setAttribute("value",q[w].getAttribute("title")),O.setAttribute("data-href",new URI(q[w].getAttribute("href")).resolve(s).toString());var N=U.appendChild(e.createElement("label"));N.setAttribute("for","rad"+w),N.innerText=q[w].getAttribute("title"),"style self"!==q[w].getAttribute("rel")&&"self style"!==q[w].getAttribute("rel")||(O.checked=!0),C.appendChild(U),L.DomUtil.addClass(C,"mapml-control-layers"),L.DomEvent.on(O,"click",P,a)}a._styles=C}i.querySelector("title")?a._title=i.querySelector("title").textContent.trim():i.hasAttribute("label")&&(a._title=i.getAttribute("label").trim()),a._map&&(a._validateExtent(),a._map.hasLayer(a)&&a._map.attributionControl.addAttribution(a.getAttribution()))}else a.error=!0;a.fire("extentload",a,!1)}},_getMapML:function(t){var i=this;if(t){var r=0,a=new XMLHttpRequest;this._map.once("movestart",function(){a.abort()}),o(t,s)}else this._content&&s(this._content);function o(t,e){a.onreadystatechange=function(){this.readyState===this.DONE&&(400!==this.status&&404!==this.status&&500!==this.status&&406!==this.status||(i.error=!0,i.fire("extentload",i,!0),a.abort()))},a.onload=e,a.onerror=function(){console.error(this.statusText),i.error=!0},a.open("GET",t),a.setRequestHeader("Accept",n.mime+";projection="+i.options.mapprojection+";zoom="+i.zoom),a.overrideMimeType("text/xml"),a.send()}function s(t){var a,l,m,u,h,p,c=this.responseXML||t;if(c){if(0===r){var d=c.querySelector("extent");if(d){if(!d.hasAttribute("action")&&d.querySelector("link[rel=tile],link[rel=image],link[rel=features],link[rel=query]")&&d.hasAttribute("units")){i._templateVars=[];var g=d.querySelectorAll("link[rel=tile],link[rel=image],link[rel=features],link[rel=query]"),y=new RegExp("(?:{)(.*?)(?:})","g"),x=d.querySelector('input[type="zoom" i]'),f=!1;for(a=0;a<g.length;a++){for(var L,_=g[a],b=_.getAttribute("tref"),v=b.match(y),A=_.hasAttribute("rel")&&"tile"!==_.getAttribute("rel").toLowerCase()?_.getAttribute("rel").toLowerCase():"tile",S=[];null!==(L=y.exec(b));){var T=L[1],E=d.querySelector("input[name="+T+"]");if(!E){console.log("input with name="+T+" not found for template variable of same name");break}S.push(E),f=E.hasAttribute("type")&&"zoom"===E.getAttribute("type").toLowerCase()}b&&v.length===S.length&&(!f&&x&&S.push(x),i._templateVars.push({template:b,type:A,values:S}))}}}else d=i._synthesizeExtent(c);i._extent=d,i._parseLicenseAndLegend(c,i);var I=c.querySelector("link[rel=zoomin]"),z=c.querySelector("link[rel=zoomout]"),q=new URI(c.querySelector("base")?c.querySelector("base").getAttribute("href"):this.responseURL).resolve(new URI(this.responseURL));delete i._extent.zoomin,delete i._extent.zoomout,I&&(i._extent.zoomin=new URI(I.getAttribute("href")).resolve(q).toString()),z&&(i._extent.zoomout=new URI(z.getAttribute("href")).resolve(q).toString())}if(c.querySelector("feature")&&i._mapmlvectors.addData(c),c.querySelector("tile")){var C=e.createElement("tiles"),M=c.querySelector("meta[name=zoom][content]")||c.querySelector("input[type=zoom][value]");C.setAttribute("zoom",M.getAttribute("content")||M.getAttribute("value"));var P=c.getElementsByTagName("tile");for(a=0;a<P.length;a++)Polymer.dom(C).appendChild(e.importNode(P[a],!0));i._mapmlTileContainer.appendChild(C)}if(c.querySelector("image")){var w=c.getElementsByTagName("image"),U=[],O=i._imageContainer;for(a=0;a<w.length;a++){var N=w[a].getAttribute("src"),B=i._map,k=B.getPixelBounds().min.subtract(B.getPixelOrigin()),R=B.getSize();U[a]=n.imageOverlay(N,k,R,0,O)}var D=i._imageLayer.getLayers(),F=U.length-1,j=function(){for(var t=0;t<D.length;t++)i._imageLayer.removeLayer(D[t])};for(a=0;a<U.length;a++)i._imageLayer.addLayer(U[a]),a===F&&U[a].on("load",j)}var G=(l="next",u=(m=c).querySelector("base"),h=new URI((u?u.getAttribute("href"):null)||m.baseURI),(p=m.querySelector("link[rel="+l+"]"))?new URI(p.getAttribute("href")).resolve(h):null);G&&r<i.options.maxNext?(r++,o(G,s)):(i._mapmlTileContainer.getElementsByTagName("tile").length>0&&i._tileLayer._onMapMLProcessed(),i.fire("extentload",i,!0))}}},_createExtent:function(){var t=e.createElement("extent"),i=e.createElement("input"),n=e.createElement("input"),r=e.createElement("input"),a=e.createElement("input"),o=e.createElement("input"),s=e.createElement("input");return o.setAttribute("type","zoom"),o.setAttribute("min","0"),o.setAttribute("max","0"),i.setAttribute("type","xmin"),i.setAttribute("min",""),i.setAttribute("max",""),n.setAttribute("type","ymin"),n.setAttribute("min",""),n.setAttribute("max",""),r.setAttribute("type","xmax"),r.setAttribute("min",""),r.setAttribute("max",""),a.setAttribute("type","ymax"),a.setAttribute("min",""),a.setAttribute("max",""),s.setAttribute("type","projection"),s.setAttribute("value","WGS84"),t.setAttribute("action","synthetic"),Polymer.dom(t).appendChild(i),Polymer.dom(t).appendChild(n),Polymer.dom(t).appendChild(r),Polymer.dom(t).appendChild(a),Polymer.dom(t).appendChild(o),Polymer.dom(t).appendChild(s),t},_validateExtent:function(){var t=this._extent;if(t&&t.querySelector&&this._map){if(t.querySelector('[type=xmin][min=""], [type=xmin][max=""], [type=xmax][min=""], [type=xmax][max=""], [type=ymin][min=""], [type=ymin][max=""]')){var e,i,r=t.querySelector("[type=xmin]"),a=t.querySelector("[type=ymin]"),o=t.querySelector("[type=xmax]"),s=t.querySelector("[type=ymax]"),l=t.querySelector("[type=projection][value]");l?(i=l.getAttribute("value"))&&"WGS84"===i?(e=this._map.getBounds(),r.setAttribute("min",e.getWest()),r.setAttribute("max",e.getEast()),a.setAttribute("min",e.getSouth()),a.setAttribute("max",e.getNorth()),o.setAttribute("min",e.getWest()),o.setAttribute("max",e.getEast()),s.setAttribute("min",e.getSouth()),s.setAttribute("max",e.getNorth())):i&&(e=this._map.getPixelBounds(),r.setAttribute("min",e.getBottomLeft().x),r.setAttribute("max",e.getTopRight().x),a.setAttribute("min",e.getTopRight().y),a.setAttribute("max",e.getBottomLeft().y),o.setAttribute("min",e.getBottomLeft().x),o.setAttribute("max",e.getTopRight().x),s.setAttribute("min",e.getTopRight().y),s.setAttribute("max",e.getBottomLeft().y)):this.error=!0}if(t.querySelector('[type=zoom][min=""], [type=zoom][max=""]')){var m=t.querySelector("[type=zoom]");m.setAttribute("min",this._map.getMinZoom()),m.setAttribute("max",this._map.getMaxZoom())}var u=t.hasAttribute("units")?t.getAttribute("units"):null;this.crs=u&&"OSMTILE"===u||"WGS84"===u||"APSTILE"===u||"CBMTILE"===u?n[u]:n.OSMTILE}},_getMapMLExtent:function(t,e,i){var n=this._createExtent(),r=n.querySelector("input[type=zoom]"),a=n.querySelector("input[type=xmin]"),o=n.querySelector("input[type=ymin]"),s=n.querySelector("input[type=xmax]"),l=n.querySelector("input[type=ymax]"),m=n.querySelector("input[type=projection]"),u=void 0!==e[0]&&void 0!==e[1]?Math.min(e[0],e[1]):"",h=void 0!==e[0]&&void 0!==e[1]?Math.max(e[0],e[1]):"",p=t?t._southWest?t.getWest():t.getBottomLeft().x:"",c=t?t._southWest?t.getSouth():t.getTopRight().y:"",d=t?t._southWest?t.getEast():t.getTopRight().x:"",g=t?t._southWest?t.getNorth():t.getBottomLeft().y:"";return r.setAttribute("min","number"==typeof u&&isNaN(u)?"":u),r.setAttribute("max","number"==typeof h&&isNaN(h)?"":h),a.setAttribute("min",p),a.setAttribute("max",d),o.setAttribute("min",c),o.setAttribute("max",g),s.setAttribute("min",p),s.setAttribute("max",d),l.setAttribute("min",c),l.setAttribute("max",g),m.setAttribute("value",t&&t._southWest&&!i?"WGS84":i),n},_synthesizeExtent:function(t){var e,i,n,r,a,o,s,l,m,u,h,p,c=t.querySelectorAll("meta[name=zoom]")[0],d=t.querySelector("meta[name=extent]"),g=t.querySelector("meta[name=projection]"),y=g?g.getAttribute("content"):"WGS84";if(c)for(i=c.getAttribute("content").split(","),e=0;e<i.length;e++)h=(u=i[e].split("="))[0],p=u[1],"min"===h&&(r=parseInt(p)),"max"===h&&(a=parseInt(p));if(d)for(i=d.getAttribute("content").split(","),e=0;e<i.length;e++)h=(u=i[e].split("="))[0],p=u[1],"xmin"===h&&(o=parseFloat(p)),"xmax"===h&&(l=parseFloat(p)),"ymin"===h&&(s=parseFloat(p)),"ymax"===h&&(m=parseFloat(p));if(o&&s&&l&&m&&"WGS84"===y){var x=L.latLng(s,o),f=L.latLng(m,l);n=L.latLngBounds(x,f)}else o&&s&&l&&m&&(n=L.bounds([[o,s],[l,m]]));return this._getMapMLExtent(n,[r,a],y)},getProjection:function(){if(!this._extent||!this._extent.querySelector("input[type=projection]"))return"WGS84";var t=this._extent.querySelector("input[type=projection]");return t.getAttribute("value")?t.getAttribute("value"):"WGS84"},_parseLicenseAndLegend:function(t,e){var i,n,r=t.querySelector("link[rel=license]");r&&(i=r.getAttribute("title"),n='<a href="'+r.getAttribute("href")+'" title="'+i+'">'+i+"</a>"),L.setOptions(e,{attribution:n});var a=t.querySelector("link[rel=legend]");a&&(e._legendUrl=a.getAttribute("href"))},_onMoveEnd:function(){var t=this._calculateUrl();t?(this.href=t,this.fire("loadstart"),this._mapmlvectors.clearLayers(),this._initEl(),this._getMapML(t)):this._content&&!this._mapmlvectors.getLayers().length&&this._getMapML(null)},_initEl:function(){if(this._mapmlTileContainer)for(var t=this._mapmlTileContainer;t.firstChild;)t.removeChild(t.firstChild)},_reset:function(){this._initEl(),L.empty(this._container),this._mapmlvectors.clearLayers()},_getUnprojectedMapLatLngBounds:function(t){var e=(t=t||this._map).getPixelOrigin(),i=t.getPixelBounds(),n=t.unproject(e),r=t.unproject(i.getBottomLeft()),a=t.unproject(i.getTopRight()),o=t.unproject(e.add(t.getSize()));return L.latLngBounds(r,a).extend(o).extend(n)},_calculateUrl:function(){if(!this._map)return null;if(!this._mapmlTileContainer&&!this._extent)return this._href;var t=this._extent;if(!t)return this._href;var e=t.getAttribute("action"),i=new URI(this._href),n=t.querySelectorAll("input[type=zoom]")[0];if(!n)return null;var r,a=parseInt(n.getAttribute("min")),o=parseInt(n.getAttribute("max")),s={},l=this._map.getZoom();if(a<=l&&l<=o)s.zoom=l;else{if(e)return null;if(t.zoomin&&l>o)return this._href=t.zoomin,this.href=t.zoomin,this.href;if(t.zoomout&&l<a)return this._href=t.zoomout,this.href=t.zoomout,this.href}if(!e||"synthetic"===e)return null;r="WGS84"===t.getAttribute("units")?this._getUnprojectedMapLatLngBounds():this._map.getPixelBounds();var m=this._setUpInputVars(t.querySelectorAll("input")),u="";s[m.extent.zoom.name]=l,u+=m.extent.zoom.name+"={"+m.extent.zoom.name+"}&",s[m.extent.left.name]=r.min?r.min.x:r.getWest(),u+=m.extent.left.name+"={"+m.extent.left.name+"}&",s[m.extent.bottom.name]=r.max?r.max.y:r.getSouth(),u+=m.extent.bottom.name+"={"+m.extent.bottom.name+"}&",s[m.extent.right.name]=r.max?r.max.x:r.getEast(),u+=m.extent.right.name+"={"+m.extent.right.name+"}&",s[m.extent.top.name]=r.min?r.min.y:r.getNorth(),u+=m.extent.top.name+"={"+m.extent.top.name+"}"+(m.extent.hidden.length>0?"&":"");for(var h=0;h<m.extent.hidden.length;h++)s[m.extent.hidden[h].name]=m.extent.hidden[h].value,u+=m.extent.hidden[h].name+"={"+m.extent.hidden[h].name+"}"+(h<m.extent.hidden.length-1?"&":"");var p=new URI(e+="?"+u).resolve(i).toString();return L.Util.template(p,s)},_projectionMatches:function(t){t=t||this._map;var e=this.getProjection();return!(!t.options.projection||"WGS84"!==e&&t.options.projection!==e)},getQueryTemplates:function(){if(this._templatedLayer&&this._templatedLayer._queries)return this._templatedLayer._queries}}),n.mapMLLayer=function(t,i,r){return new n.MapMLLayer(t,i||e.createElement("div"),r)},n.ImageOverlay=L.ImageOverlay.extend({initialize:function(t,e,i,n,r,a){this._container=r,this._url=t,this._location=e,this._size=L.point(i),this._angle=n,L.setOptions(this,a)},getEvents:function(){var t={viewreset:this._reset};return this._zoomAnimated&&(t.zoomanim=this._animateZoom),t},onAdd:function(){this.on({load:this._onImageLoad}),this._image||this._initImage(),this.options.interactive&&(L.DomUtil.addClass(this._image,"leaflet-interactive"),this.addInteractiveTarget(this._image)),Polymer.dom(this._container).appendChild(this._image),this._reset()},onRemove:function(){L.DomUtil.remove(this._image),this.options.interactive&&this.removeInteractiveTarget(this._image)},_onImageLoad:function(){this._image&&(this._image.loaded=+new Date,this._updateOpacity())},_animateZoom:function(t){var e=this._map.getZoomScale(t.zoom),i=this._map.getPixelOrigin().add(this._location).multiplyBy(e).subtract(this._map._getNewPixelOrigin(t.center,t.zoom)).round();L.Browser.any3d?L.DomUtil.setTransform(this._image,i,e):L.DomUtil.setPosition(this._image,i)},_reset:function(){var t=this._image,e=this._location,i=this._size;L.DomUtil.setPosition(t,e),t.style.width=i.x+"px",t.style.height=i.y+"px"},_updateOpacity:function(){if(this._map){var t=+new Date,e=!1,i=this._image,n=Math.min(1,(t-i.loaded)/200);L.DomUtil.setOpacity(i,n),n<1&&(e=!0),e&&(L.Util.cancelAnimFrame(this._fadeFrame),this._fadeFrame=L.Util.requestAnimFrame(this._updateOpacity,this)),L.DomUtil.addClass(i,"leaflet-image-loaded")}}}),n.imageOverlay=function(t,e,i,r,a,o){return new n.ImageOverlay(t,e,i,r,a,o)},n.TemplatedImageLayer=L.Layer.extend({initialize:function(t,e){this._template=t,this._container=L.DomUtil.create("div","leaflet-layer",e.pane),L.DomUtil.addClass(this._container,"mapml-image-container"),L.setOptions(this,L.extend(e,this._setUpExtentTemplateVars(t)))},getEvents:function(){return{moveend:this._onMoveEnd}},onAdd:function(){this.setZIndex(this.options.zIndex),this._onMoveEnd()},redraw:function(){this._onMoveEnd()},_onMoveEnd:function(){var t=this._map,e=t.getPixelBounds().min.subtract(t.getPixelOrigin()),i=t.getSize(),r=this.getImageUrl(),a=this._imageOverlay;this._imageOverlay=n.imageOverlay(r,e,i,0,this._container),this._imageOverlay.addTo(t),a&&this._imageOverlay.on("load error",function(){t.removeLayer(a)})},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},_updateZIndex:function(){this._container&&void 0!==this.options.zIndex&&null!==this.options.zIndex&&(this._container.style.zIndex=this.options.zIndex)},onRemove:function(){},getImageUrl:function(){var t={};for(var e in t[this.options.extent.width]=this._map.getSize().x,t[this.options.extent.height]=this._map.getSize().y,t[this.options.extent.bottom]=this._TCRSToPCRS(this._map.getPixelBounds().max,this._map.getZoom()).y,t[this.options.extent.left]=this._TCRSToPCRS(this._map.getPixelBounds().min,this._map.getZoom()).x,t[this.options.extent.top]=this._TCRSToPCRS(this._map.getPixelBounds().min,this._map.getZoom()).y,t[this.options.extent.right]=this._TCRSToPCRS(this._map.getPixelBounds().max,this._map.getZoom()).x,this.options.extent)["width","height","left","right","top","bottom"].indexOf(e)<0&&(t[e]=this.options.extent[e]);return L.Util.template(this._template.template,t)},_TCRSToPCRS:function(t,e){var i=this._map.options.crs;return i.transformation.untransform(t,i.scale(e))},_setUpExtentTemplateVars:function(t){for(var e={extent:{}},i=t.values,n=0;n<t.values.length;n++){var r=i[n].getAttribute("type"),a=i[n].getAttribute("units"),o=i[n].getAttribute("axis"),s=i[n].getAttribute("name"),l=i[n].getAttribute("position"),m="select"===i[n].tagName.toLowerCase();if("width"===r)e.extent.width=s;else if("height"===r)e.extent.height=s;else if("location"!==r||"pcrs"!==a&&"gcrs"!==a)if(m){const t=i[n].htmlselect;e.extent[s]=function(){return t.value}}else{const t=i[n];e.extent[s]=function(){return t.getAttribute("value")}}else switch(o){case"longitude":case"easting":l&&(l.match(/.*?-left/i)?e.extent.left=s:l.match(/.*?-right/i)&&(e.extent.right=s));break;case"latitude":case"northing":l&&(l.match(/top-.*?/i)?e.extent.top=s:l.match(/bottom-.*?/i)&&(e.extent.bottom=s))}}return e}}),n.templatedImageLayer=function(t,e){return new n.TemplatedImageLayer(t,e)},n.TemplatedFeaturesLayer=L.Layer.extend({initialize:function(t,e){this._template=t,this._container=L.DomUtil.create("div","leaflet-layer",e.pane),L.DomUtil.addClass(this._container,"mapml-features-container"),L.setOptions(this,L.extend(e,this._setUpFeaturesTemplateVars(t)))},getEvents:function(){return{moveend:this._onMoveEnd}},onAdd:function(){var t,i=new Headers({Accept:"text/mapml"}),r=new DOMParser,a=this.options.opacity,o=this._container,s=this._map;this._features||(this._features=n.mapMlFeatures(null,{renderer:L.svg(),pane:o,opacity:a,imagePath:this.options.imagePath,onEachFeature:function(t,i){var n=e.createElement("div");n.insertAdjacentHTML("afterbegin",t.innerHTML),i.bindPopup(n,{autoPan:!1})}}));var l=this._features,m=function(e,n){return fetch(e,{redirect:"follow",headers:i}).then(function(t){return t.text()}).then(function(i){var a=new URI((t=r.parseFromString(i,"application/xml")).querySelector("base")?t.querySelector("base").getAttribute("href"):e);if(e=(e=t.querySelector("link[rel=next]")?t.querySelector("link[rel=next]").getAttribute("href"):null)?new URI(e).resolve(a).toString():null,l.addData(t),e&&--n)return m(e,n)})};m(this._getfeaturesUrl(),10).then(function(){s.addLayer(l)}).catch(function(t){console.log(t)})},_onMoveEnd:function(){this._features.clearLayers();var t,e=new Headers({Accept:"text/mapml;q=0.9,application/geo+json;q=0.8"}),i=new DOMParser,n=this._features,r=this._map,a=function(r,o){return fetch(r,{redirect:"follow",headers:e}).then(function(t){return t.text()}).then(function(e){var s=new URI((t=i.parseFromString(e,"application/xml")).querySelector("base")?t.querySelector("base").getAttribute("href"):r);if(r=(r=t.querySelector("link[rel=next]")?t.querySelector("link[rel=next]").getAttribute("href"):null)?new URI(r).resolve(s).toString():null,n.addData(t),r&&--o)return a(r,o)})};a(this._getfeaturesUrl(),10).then(function(){r.addLayer(n)}).catch(function(t){console.log(t)})},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},_updateZIndex:function(){this._container&&void 0!==this.options.zIndex&&null!==this.options.zIndex&&(this._container.style.zIndex=this.options.zIndex)},onRemove:function(){this._map.removeLayer(this._features)},_getfeaturesUrl:function(){var t=this._map.getPixelBounds(),e=t.getTopLeft(),i=t.getTopRight(),n=t.getBottomRight(),r=t.getBottomLeft(),a=this._map.getBounds();a.extend(this._map.unproject(r)).extend(this._map.unproject(n)).extend(this._map.unproject(e)).extend(this._map.unproject(i));var o={};for(var s in o[this.options.feature.zoom.name]=this._map.getZoom(),o[this.options.feature.bottom.name]=a.getSouth(),o[this.options.feature.left.name]=a.getWest(),o[this.options.feature.top.name]=a.getNorth(),o[this.options.feature.right.name]=a.getEast(),this.options.feature)["width","height","left","right","top","bottom","zoom"].indexOf(s)<0&&(o[s]=this.options.feature[s]);return L.Util.template(this._template.template,o)},_setUpFeaturesTemplateVars:function(t){var e={feature:{}},i=t.values;e.feature.hidden=[];for(var n=0;n<i.length;n++){var r=i[n].getAttribute("type"),a=i[n].getAttribute("units"),o=i[n].getAttribute("axis"),s=i[n].getAttribute("name"),l=i[n].getAttribute("position"),m=i[n].getAttribute("value"),u="select"===i[n].tagName.toLowerCase();if("width"===r)e.feature.width={name:s};else if("height"===r)e.feature.height={name:s};else if("zoom"===r)e.feature.zoom={name:s};else if("location"!==r||"pcrs"!==a&&"gcrs"!==a&&"tcrs"!==a)if(u){const t=i[n].htmlselect;e.feature[s]=function(){return t.value}}else"hidden"!==r&&"projection"!==r||e.feature.hidden.push({name:s,value:m});else switch(o){case"x":case"longitude":case"easting":l&&(l.match(/.*?-left/i)?e.feature.left={name:s,axis:o}:l.match(/.*?-right/i)&&(e.feature.right={name:s,axis:o}));break;case"y":case"latitude":case"northing":l&&(l.match(/top-.*?/i)?e.feature.top={name:s,axis:o}:l.match(/bottom-.*?/i)&&(e.feature.bottom={name:s,axis:o}))}}return e}}),n.templatedFeaturesLayer=function(t,e){return new n.TemplatedFeaturesLayer(t,e)},n.TemplatedLayer=L.Layer.extend({initialize:function(t,e){this._templates=t,L.setOptions(this,e),this._container=L.DomUtil.create("div","leaflet-layer",e.pane),L.DomUtil.addClass(this._container,"mapml-templatedlayer-container");for(var i=0;i<t.length;i++)"tile"===t[i].type?this._templates[i].layer=n.templatedTileLayer(t[i],L.Util.extend(e,{errorTileUrl:"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",zIndex:i,pane:this._container})):"image"===t[i].type?this._templates[i].layer=n.templatedImageLayer(t[i],L.Util.extend(e,{zIndex:i,pane:this._container})):"features"===t[i].type?this._templates[i].layer=n.templatedFeaturesLayer(t[i],L.Util.extend(e,{zIndex:i,pane:this._container})):"query"===t[i].type&&(this._queries||(this._queries=[]),this._queries.push(L.extend(t[i],this._setupQueryVars(t[i]))))},getEvents:function(){return{zoomstart:this._onZoomStart}},redraw:function(){this.closePopup();for(var t=0;t<this._templates.length;t++)"tile"!==this._templates[t].type&&"image"!==this._templates[t].type&&"features"!==this._templates[t].type||this._templates[t].layer.redraw()},_onZoomStart:function(){this.closePopup()},_setupQueryVars:function(t){for(var e={query:{}},i=t.values,n=0;n<t.values.length;n++){var r=i[n].getAttribute("type"),a=i[n].getAttribute("units"),o=i[n].getAttribute("axis"),s=i[n].getAttribute("name"),l=i[n].getAttribute("position"),m=i[n].getAttribute("rel"),u="select"===i[n].tagName.toLowerCase();if("width"===r)e.query.width=s;else if("height"===r)e.query.height=s;else if("location"===r)switch(o){case"x":case"y":case"column":case"row":e.query[o]=s;break;case"longitude":case"easting":l?l.match(/.*?-left/i)?"pixel"===m?e.query.pixelleft=s:"tile"===m?e.query.tileleft=s:e.query.mapleft=s:l.match(/.*?-right/i)&&("pixel"===m?e.query.pixelright=s:"tile"===m?e.query.tileright=s:e.query.mapright=s):e.query[o]=s;break;case"latitude":case"northing":l?l.match(/top-.*?/i)?"pixel"===m?e.query.pixeltop=s:"tile"===m?e.query.tiletop=s:e.query.maptop=s:l.match(/bottom-.*?/i)&&("pixel"===m?e.query.pixelbottom=s:"tile"===m?e.query.tilebottom=s:e.query.mapbottom=s):e.query[o]=s;break;case"i":"tile"===a?e.query.tilei=s:e.query.mapi=s;break;case"j":"tile"===a?e.query.tilej=s:e.query.mapj=s}else if("zoom"===r)e.query.zoom=s;else if(u){const t=i[n].htmlselect;e.query[s]=function(){return t.value}}else{const t=i[n];e.query[s]=function(){return t.getAttribute("value")}}}return e.query.title=t.title,e},reset:function(t){if(t&&this._map){var e=this._map&&this._map.hasLayer(this),i=this._templates;delete this._queries,this._map.off("click",null,this),this._templates=t;for(var r=0;r<t.length;r++)"tile"===t[r].type?this._templates[r].layer=n.templatedTileLayer(t[r],L.Util.extend(this.options,{errorTileUrl:"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",zIndex:r,pane:this._container})):"image"===t[r].type?this._templates[r].layer=n.templatedImageLayer(t[r],L.Util.extend(this.options,{zIndex:r,pane:this._container})):"features"===t[r].type?this._templates[r].layer=n.templatedFeaturesLayer(t[r],L.Util.extend(this.options,{zIndex:r,pane:this._container})):"query"===t[r].type&&(this._queries||(this._queries=[]),this._queries.push(L.extend(t[r],this._setupQueryVars(t[r])))),e&&this.onAdd(this._map);for(r=0;r<i.length;r++)this._map.hasLayer(i[r].layer)&&this._map.removeLayer(i[r].layer)}},onAdd:function(t){for(var e=0;e<this._templates.length;e++)"query"!==this._templates[e].type&&t.addLayer(this._templates[e].layer)},onRemove:function(t){L.DomUtil.remove(this._container);for(var e=0;e<this._templates.length;e++)"query"!==this._templates[e].type&&t.removeLayer(this._templates[e].layer)}}),n.templatedLayer=function(t,e){return new n.TemplatedLayer(t,e)},n.TemplatedTileLayer=L.TileLayer.extend({initialize:function(t,e){L.setOptions(this,e),this._setUpTileTemplateVars(t),t.tile.subdomains&&L.setOptions(this,L.extend(this.options,{subdomains:t.tile.subdomains})),this._template=t,this._initContainer(),L.TileLayer.prototype.initialize.call(this,t.template,L.extend(e,{pane:this._container}))},getPane:function(){return this.options.pane},_initContainer:function(){this._container||(this._container=L.DomUtil.create("div","leaflet-layer",this.options.pane),L.DomUtil.addClass(this._container,"mapml-templated-tile-container"),this._updateZIndex(),this.options.opacity<1&&this._updateOpacity())},getTileUrl:function(t){if(t.z>=this._template.tilematrix.bounds.length||!this._template.tilematrix.bounds[t.z].contains(t))return"";var e={};for(var i in e[this._template.tilematrix.col.name]=t.x,e[this._template.tilematrix.row.name]=t.y,e[this._template.zoom.name]=this._getZoomForUrl(),e[this._template.pcrs.easting.left]=this._tileMatrixToPCRSPosition(t,"top-left").x,e[this._template.pcrs.easting.right]=this._tileMatrixToPCRSPosition(t,"top-right").x,e[this._template.pcrs.northing.top]=this._tileMatrixToPCRSPosition(t,"top-left").y,e[this._template.pcrs.northing.bottom]=this._tileMatrixToPCRSPosition(t,"bottom-left").y,e[this._template.tile.server]=this._getSubdomain(t),this._template.tile)["row","col","zoom","left","right","top","bottom"].indexOf(i)<0&&(e[i]=this._template.tile[i]);return e.r=this.options.detectRetina&&L.Browser.retina&&this.options.maxZoom>0?"@2x":"",L.Util.template(this._url,e)},_tileMatrixToPCRSPosition:function(t,e){var i=this._map.options.crs,n=this.getTileSize(),r=t.scaleBy(n),a=r.add(n),o=r.add(Math.floor(n/2)),s=i.transformation.untransform(r,i.scale(t.z)),l=i.transformation.untransform(a,i.scale(t.z)),m=i.transformation.untransform(o,i.scale(t.z)),u=null;switch(e){case"top-left":u=s;break;case"bottom-left":u=new L.Point(s.x,l.y);break;case"center-left":u=new L.Point(s.x,m.y);break;case"top-right":u=new L.Point(l.x,s.y);break;case"bottom-right":u=l;break;case"center-right":u=new L.Point(l.x,m.y);break;case"top-center":u=new L.Point(m.x,s.y);break;case"bottom-center":u=new L.Point(m.x,l.y);break;case"center":u=m}return u},_setUpTileTemplateVars:function(t){t.tile={};for(var e,i,n,r,a,o=t.values,s=this.options.crs.options,l=0;l<t.values.length;l++){var m=o[l].getAttribute("type"),u=o[l].getAttribute("units"),h=o[l].getAttribute("axis"),p=o[l].getAttribute("name"),c=o[l].getAttribute("position"),d="hidden"===m&&o[l].hasAttribute("shard"),g="select"===o[l].tagName.toLowerCase(),y=o[l].getAttribute("value"),x=o[l].getAttribute("min"),f=o[l].getAttribute("max");if("location"===m&&"tilematrix"===u)switch(h){case"column":a={name:p,min:s.crs.tilematrix.horizontal.min,max:s.crs.tilematrix.horizontal.max(s.resolutions.length-1)},isNaN(Number.parseInt(x,10))||(a.min=Number.parseInt(x,10)),isNaN(Number.parseInt(f,10))||(a.max=Number.parseInt(f,10));break;case"row":r={name:p,min:s.crs.tilematrix.vertical.min,max:s.crs.tilematrix.vertical.max(s.resolutions.length-1)},isNaN(Number.parseInt(x,10))||(r.min=Number.parseInt(x,10)),isNaN(Number.parseInt(f,10))||(r.max=Number.parseInt(f,10));break;case"longitude":case"easting":i||(i={min:s.crs.pcrs.horizontal.min,max:s.crs.pcrs.horizontal.max}),isNaN(Number.parseFloat(x))||(i.min=Number.parseFloat(x)),isNaN(Number.parseFloat(f))||(i.max=Number.parseFloat(f)),c&&(c.match(/.*?-left/i)?i.left=p:c.match(/.*?-right/i)&&(i.right=p));break;case"latitude":case"northing":n||(n={min:s.crs.pcrs.vertical.min,max:s.crs.pcrs.vertical.max}),isNaN(Number.parseFloat(x))||(n.min=Number.parseFloat(x)),isNaN(Number.parseFloat(f))||(n.max=Number.parseFloat(f)),c&&(c.match(/top-.*?/i)?n.top=p:c.match(/bottom-.*?/i)&&(n.bottom=p))}else if("zoom"===m.toLowerCase())e={name:p,min:0,max:s.resolutions.length},!isNaN(Number.parseInt(y,10))&&Number.parseInt(y,10)>=e.min&&Number.parseInt(y,10)<=e.max&&(e.value=Number.parseInt(y,10)),!isNaN(Number.parseInt(x,10))&&Number.parseInt(x,10)>=e.min&&Number.parseInt(x,10)<=e.max&&(e.min=Number.parseInt(x,10)),!isNaN(Number.parseInt(f,10))&&Number.parseInt(f,10)>=e.min&&Number.parseInt(f,10)<=e.max&&(e.max=Number.parseInt(f,10)),t.zoom=e;else if(d)t.tile.server=p,t.tile.subdomains=o[l].servers.slice();else if(g){const e=o[l].htmlselect;t.tile[p]=function(){return e.value}}else{const e=o[l];t.tile[p]=function(){return e.getAttribute("value")}}}var _=this.options.crs.transformation,b=L.bind(this.options.crs.scale,this.options.crs);tilematrix2pcrs=function(t,e){return _.untransform(t.multiplyBy(256),b(e))},pcrs2tilematrix=function(t,e){return _.transform(t,b(e)).divideBy(256).floor()},i&&n?(t.pcrs={},t.pcrs.bounds=L.bounds([i.min,n.min],[i.max,n.max]),t.pcrs.easting=i,t.pcrs.northing=n):a&&r&&!isNaN(e.value)?(t.pcrs||(t.pcrs={},t.pcrs.easting="",t.pcrs.northing=""),t.pcrs.bounds=L.bounds(tilematrix2pcrs(L.point([a.min,r.min]),e.value),tilematrix2pcrs(L.point([a.max,r.max]),e.value)),t.tilematrix={},t.tilematrix.col=a,t.tilematrix.row=r):console.log("Unable to determine bounds for tile template: "+t.template),t.tilematrix||(t.tilematrix={},t.tilematrix.col={},t.tilematrix.row={}),t.tilematrix.bounds=[];for(var v=t.pcrs.bounds,A=t.zoom?t.zoom.min:0,S=t.zoom?t.zoom.max:s.resolutions.length,T=0;T<=S;T++)t.tilematrix.bounds[T]=T>=A?L.bounds(pcrs2tilematrix(v.min,T),pcrs2tilematrix(v.max,T)):L.bounds(L.point([-1,-1]),L.point([-1,-1]))}}),n.templatedTileLayer=function(t,e){return new n.TemplatedTileLayer(t,e)},n.MapMLTileLayer=L.TileLayer.extend({initialize:function(t,e){L.setOptions(this,e),L.TileLayer.prototype.initialize.call(this,t,e)},_initContainer:function(){this._container||(this._container=L.DomUtil.create("div","leaflet-layer",this.getPane()),L.DomUtil.addClass(this._container,"mapml-tilelayer-container"),this._updateZIndex(),this.options.opacity<1&&this._updateOpacity())},getEvents:function(){var t={};return this._zoomAnimated&&(t.zoomanim=this._animateZoom),t},getPane:function(){return this.options.pane},_onMapMLProcessed:function(){this._map&&(L.DomUtil.hasClass(this._map.getPane("mapPane"),"leaflet-zoom-anim")||this._update())},_update:function(t,e){var i=this._map;if(i&&!L.DomUtil.hasClass(i.getPane("mapPane"),"leaflet-zoom-anim")){void 0===t&&(t=i.getCenter()),void 0===e&&(e=i.getZoom());var n=Math.round(e);if(!(n>this.options.maxZoom||n<this.options.minZoom)){var r=this._getTiledPixelBounds(t,e,n),a=this._pxBoundsToTileRange(r),o=this._groupTiles(this._mapmlTileContainer.getElementsByTagName("tile"));for(var s in this._tiles)this._tiles[s].current=!1;for(var l=a.min.y;l<=a.max.y;l++)for(var m=a.min.x;m<=a.max.x;m++){var u=new L.Point(m,l);if(u.z=n,this._isValidTile(u)){var h=this._tiles[this._tileCoordsToKey(u)];if(h){h.current=!0;for(var p=0;p<o.length;p++)o[p][0].row!==h.coords.y||o[p][0].col!==h.coords.x||o.splice(p,1)}}}o.length&&(this.once("load",this._pruneTiles),this._addTiles(o))}}},_groupTiles:function(t){for(var e,i,n=[],r=0;r<t.length;r++){var a={};a.row=parseInt(t[r].getAttribute("row")),a.col=parseInt(t[r].getAttribute("col")),a.src=t[r].getAttribute("src"),n.push(a)}return e=function(t){return[t.row,t.col]},i={},n.forEach(function(t){var n=JSON.stringify(e(t));i[n]=i[n]||[],i[n].push(t)}),Object.keys(i).map(function(t){return i[t]})},_addTiles:function(t){for(var i=[],n={},r=0;r<t.length;r++)n.col=t[r][0].col,n.row=t[r][0].row,this._isValidTile(new L.Point(n.col,n.row))&&i.push(t[r]);var a=i.length;if(0!==a){var o=e.createDocumentFragment();for(this._loading||(this._loading=!0,this.fire("loading")),r=0;r<a;r++)this._addTile(i[r],o);Polymer.dom(this._level.el).appendChild(o)}},_addTile:function(t,i){var n=new L.Point(t[0].col,t[0].row);n.z=this._map.getZoom();for(var r,a,o=this._tileCoordsToKey(n),s=0;s<t.length;s++)r=this.createTile(t[s].src,L.bind(this._tileReady,this,n)),this._initTile(r),t[s].img=r;if(this._tiles[o])a=this._tiles[o].el;else for(a=e.createElement("div"),L.DomUtil.addClass(a,"leaflet-tile"),s=0;s<t.length;s++)Polymer.dom(a).appendChild(t[s].img);L.DomUtil.setPosition(a,this._getTilePos(n)),this._tiles[o]={el:a,coords:n,current:!0},Polymer.dom(i).appendChild(a),this.fire("tileloadstart",{tile:r,coords:n})},_initTile:function(t){var e=this.getTileSize();t.style.width=e.x+"px",t.style.height=e.y+"px",t.onselectstart=L.Util.falseFn,t.onmousemove=L.Util.falseFn,L.Browser.ielt9&&this.options.opacity<1&&L.DomUtil.setOpacity(t,this.options.opacity),L.Browser.android&&!L.Browser.android23&&(t.style.WebkitBackfaceVisibility="hidden")},_noTilesToLoad:function(){for(var t in this._tiles)if(!L.DomUtil.hasClass(this._tiles[t].el,"leaflet-tile-loaded"))return!1;return!0},createTile:function(t,i){var n=e.createElement("img");return n.onload=L.bind(this._tileOnLoad,this,i,n),n.onerror=L.bind(this._tileOnError,this,i,n),this.options.crossOrigin&&(n.crossOrigin=""),n.alt="",n.src=t,n},_tileLoad:function(t){if(t){for(var e=t.querySelectorAll("img"),i=!0,n=0;n<e.length;n++)e[n].loaded||(i=!1);i&&L.DomUtil.addClass(t,"leaflet-tile-loaded")}},_abortLoading:function(){var t,e;for(t in this._tiles){var i=this._tiles[t].el.getElementsByTagName("img");for(t=0;t<i.length;t++)(e=i[t]).onload=L.Util.falseFn,e.onerror=L.Util.falseFn,e.complete||(e.src=L.Util.emptyImageUrl,L.DomUtil.remove(e))}}}),n.mapMLTileLayer=function(t,e){return new n.MapMLTileLayer(t,e)},n.MapMLTileLayer.addInitHook(function(){this.on("tileload",function(t){var e=t.tile;this._tileLoad(e)},this)}),n.MapMLFeatures=L.FeatureGroup.extend({initialize:function(t,e){L.setOptions(this,e),this._container=L.DomUtil.create("div","leaflet-layer",this.options.pane),L.DomUtil.addClass(this._container,"leaflet-pane mapml-vector-container"),L.setOptions(this.options.renderer,{pane:this._container}),this._layers={},t&&this.addData(t)},addData:function(t){var i,r,a,o=t.nodeType===Node.DOCUMENT_NODE||"LAYER-"===t.nodeName?t.getElementsByTagName("feature"):null,s=t.nodeType===Node.DOCUMENT_NODE?t.querySelectorAll("link[rel=stylesheet]"):null;if(s)for(i=0;i<s.length;i++){var l=t.querySelector("base"),m=s[i],u=new URI(l?l.getAttribute("href"):t.baseURI);if((m=new URI(m.getAttribute("href")).resolve(u).toString())&&!e.head.querySelector("link[href='"+m+"']")){var h=e.createElementNS("http://www.w3.org/1999/xhtml","link");h.setAttribute("href",m),h.setAttribute("type","text/css"),h.setAttribute("rel","stylesheet"),e.head.appendChild(h)}}var p=t.nodeType===Node.DOCUMENT_NODE?t.querySelectorAll("style"):null;if(p)for(i=0;i<p.length;i++)e.head.insertAdjacentHTML("beforeend",p[i].outerHTML);if(o){for(i=0,r=o.length;i<r;i++){(a=o[i]).getElementsByTagName("geometry").length&&a.getElementsByTagName("coordinates").length&&this.addData(a)}return this}var c=this.options;if(!c.filter||c.filter(t)){var d=n.MapMLFeatures.geometryToLayer(t,c.pointToLayer,c.coordsToLatLng,c);return d?(d.properties=t.getElementsByTagName("properties")[0],d.options.className=t.getAttribute("class")?t.getAttribute("class"):null,d.defaultOptions=d.options,this.resetStyle(d),c.onEachFeature&&c.onEachFeature(d.properties,d),this.addLayer(d)):void 0}},resetStyle:function(t){var e=this.options.style;e&&(L.Util.extend(t.options,t.defaultOptions),this._setLayerStyle(t,e))},setStyle:function(t){this.eachLayer(function(e){this._setLayerStyle(e,t)},this)},_setLayerStyle:function(t,e){"function"==typeof e&&(e=e(t.feature)),t.setStyle&&t.setStyle(e)}}),L.extend(n.MapMLFeatures,{geometryToLayer:function(t,e,i,n){var r,a,o,s,l,m,u="FEATURE"===t.tagName.toUpperCase()?t.getElementsByTagName("geometry")[0]:t;i=i||this.coordsToLatLng;var h={opacity:n.opacity?n.opacity:null,icon:L.icon({iconUrl:n.imagePath+"marker-icon.png",iconRetinaUrl:n.imagePath+"marker-icon-2x.png",shadowUrl:n.imagePath+"marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]})};switch(u.firstElementChild.tagName.toUpperCase()){case"POINT":return o=[],u.getElementsByTagName("coordinates")[0].textContent.split(/\s+/gim).forEach(x,o),r=i(o),e?e(t,r):new L.Marker(r,h);case"MULTIPOINT":o=[],u.getElementsByTagName("coordinates")[0].textContent.match(/(\S+ \S+)/gim).forEach(y,o),a=this.coordsToLatLngs(o,0,i);var p=new Array(a.length);for(s=0;s<p.length;s++)p[s]=new L.Marker(a[s],h);return new L.featureGroup(p);case"LINESTRING":return o=[],u.getElementsByTagName("coordinates")[0].textContent.match(/(\S+ \S+)/gim).forEach(y,o),a=this.coordsToLatLngs(o,0,i),new L.Polyline(a,n);case"MULTILINESTRING":for(l=u.getElementsByTagName("coordinates"),m=new Array(l.length),s=0;s<l.length;s++)m[s]=g(l[s]);return a=this.coordsToLatLngs(m,2,i),new L.Polyline(a,n);case"POLYGON":var c=u.getElementsByTagName("coordinates");return a=this.coordsToLatLngs(g(c),1,i),new L.Polygon(a,n);case"MULTIPOLYGON":l=u.getElementsByTagName("polygon");var d=new Array(l.length);for(s=0;s<l.length;s++)d[s]=g(l[s].querySelectorAll("coordinates"));return a=this.coordsToLatLngs(d,2,i),new L.Polygon(a,n);case"GEOMETRYCOLLECTION":console.log("GEOMETRYCOLLECTION Not implemented yet");break;default:console.log("Invalid GeoJSON object.")}function g(t){for(var e=new Array(t.length),i=0;i<e.length;i++)e[i]=[],(t[i]||t).textContent.match(/(\S+\s+\S+)/gim).forEach(y,e[i]);return e}function y(t,e,i){var n=[];t.split(/\s+/gim).forEach(x,n),this.push(n)}function x(t,e,i){this.push(parseFloat(t))}},coordsToLatLng:function(t){return new L.LatLng(t[1],t[0],t[2])},coordsToLatLngs:function(t,e,i){var n,r,a,o=[];for(r=0,a=t.length;r<a;r++)n=e?this.coordsToLatLngs(t[r],e-1,i):(i||this.coordsToLatLng)(t[r]),o.push(n);return o},latLngToCoords:function(t){var e=[t.lng,t.lat];return void 0!==t.alt&&e.push(t.alt),e},latLngsToCoords:function(t){for(var e=[],i=0,n=t.length;i<n;i++)e.push(L.MapML.latLngToCoords(t[i]));return e}}),n.mapMlFeatures=function(t,e){return new n.MapMLFeatures(t,e)},n.MapMLLayerControl=L.Control.Layers.extend({options:{autoZIndex:!1,sortLayers:!0,sortFunction:function(t,e){return t.options.zIndex<e.options.zIndex?-1:t.options.zIndex>e.options.zIndex?1:0}},initialize:function(t,e){for(var i in L.setOptions(this,e),this._layerControlInputs=[],this._layers=[],this._lastZIndex=0,this._handlingClick=!1,t)this._addLayer(t[i],i,!0)},onAdd:function(){return this._initLayout(),this._map.on("moveend",this._validateExtents,this),this._update(),this._validateExtents(),this._container},onRemove:function(t){t.off("moveend",this._validateExtents,this);for(var e=0;e<this._layers.length;e++)this._layers[e].layer.off("add remove",this._onLayerChange,this),this._layers[e].layer.off("extentload",this._validateExtents,this)},addOrUpdateOverlay:function(t,e){for(var i=!1,n=0;n<this._layers.length;n++)if(this._layers[n].layer===t){i=!0,this._layers[n].name=e;break}return i||this.addOverlay(t,e),this._map?this._update():this},_validateExtents:function(t){for(var e,i,n,r=this._map.getZoom(),a=(this._map.getPixelBounds(),0);a<this._layers.length;a++)((i=this._layers[a]).layer._extent||i.layer.error)&&(e=i.layer.getZoomBounds(),(n=i.layer._projectionMatches(this._map))&&this._withinZoomBounds(r,e)?(i.input.disabled=!1,i.input.style=null,i.input.nextElementSibling.style.fontStyle=""):(i.input.disabled=!0,n||(this._map.removeLayer(i.layer),i.input.disabled=!0,i.input.checked=!1),i.input.nextElementSibling.style.fontStyle="italic"))},_withinZoomBounds:function(t,e){return e.min<=t&&t<=e.max},_addItem:function(t){var e=t.layer.getLayerUserControlsHTML();return t.input=e.querySelector("input"),this._layerControlInputs.push(t.input),t.input.layerId=L.stamp(t.layer),L.DomEvent.on(t.input,"click",this._onInputClick,this),t.layer.on("extentload",this._validateExtents,this),Polymer.dom(this._overlaysList).appendChild(e),e}}),n.mapMlLayerControl=function(t,e){return new n.MapMLLayerControl(t,e)}}(window,document),URI.prototype.toString=function(){var t="";return this.scheme&&(t+=this.scheme+":"),this.authority&&(t+="//"+this.authority),this.path&&(t+=this.path),this.query&&(t+="?"+this.query),this.fragment&&(t+="#"+this.fragment),t},function(){var t=/\/((?!\.\.\/)[^\/]*)\/\.\.\//;function e(e){if(!e)return"";var i=e.replace(/\/\.\//g,"/");for(i=i.replace(/\/\.$/,"/");i.match(t);)i=i.replace(t,"/");for(i=i.replace(/\/([^\/]*)\/\.\.$/,"/");i.match(/\/\.\.\//);)i=i.replace(/\/\.\.\//,"/");return i}URI.prototype.resolve=function(t){var i=new URI;return this.scheme?(i.scheme=this.scheme,i.authority=this.authority,i.path=e(this.path),i.query=this.query):(this.authority?(i.authority=this.authority,i.path=e(this.path),i.query=this.query):(this.path?("/"===this.path.charAt(0)?i.path=e(this.path):(i.path=function(t,e){return t.authority&&!t.path?"/"+e:t.path.match(/^(.*)\//)[0]+e}(t,this.path),i.path=e(i.path)),i.query=this.query):(i.path=t.path,this.query?i.query=this.query:i.query=t.query),i.authority=t.authority),i.scheme=t.scheme),i.fragment=this.fragment,i}}();